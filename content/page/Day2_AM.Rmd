---
title: "Day 2 - AM"
output: 
  blogdown::html_page: 
    toc: true
    toc_depth: 1
    highlight: tango
    css: css/camp_style.css
    number_sections: true
    self_contained: false
    fontsize: 18pt
    monofont: Source Code Pro
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F)
knitr::opts_chunk$set(fig.width = 10, fig.height = 5.2) 
htmltools::tagList(rmarkdown::html_dependency_font_awesome())
```

# Good morning, Jedis! {-}
<hr class="hr2">

![](../images/day2_bb8_sq.png){width="260" style="float: left; margin-right: 60px; margin-top: -10px;"}

## Schedule  {-}

    - Review of Day 1
    - Dates continued...
    - Summarize your data
    - Pipe together functions
    - Join two tables by a shared column
    - Calculate new columns
    - Summarize for each group
    - Save data

<br>


## Porg review {-}
<hr class="hrlvl2">

The _poggle_ of porgs has returned to help review the `dplyr` functions. Follow along by downloading the __porg__ data from the URL below.

```{r, eval = F}
library(readr)
porgs <- read_csv("https://itep-r.netlify.com/data/porg_data.csv")
```

<br>

```{r porg-tabs, results='asis', echo=F}
cat(readLines("porg_tabs.txt"))
```

<br>


# New mission! 
<hr>
```{r lubridate, child='X:/Agency_Files/Outcomes/Risk_Eval_Air_Mod/_Air_Risk_Evaluation/R/R_Camp/modules/lubridate_examples/endor1.Rmd'}
```


## Back on Endor! {-}
<hr class="hrlvl2">
```{r lubridate, child='X:/Agency_Files/Outcomes/Risk_Eval_Air_Mod/_Air_Risk_Evaluation/R/R_Camp/modules/lubridate_examples/endor2.Rmd'}
```


# Pipe it together: ` A %>% B `
<hr>
```{r pipe-intro, child='X:/Agency_Files/Outcomes/Risk_Eval_Air_Mod/_Air_Risk_Evaluation/R/R_Camp/modules/dplyr_pipe/intro.Rmd'}
```

>
> __So where were we?__ 
>
> __Right! We we're enjoying our time on beautiful lush Endor. But aren't we missing somebody...?__
>


# Finn needs us! {-}

That's enough _scuttlebutting_ on Endor, Finn needs us back on Jakku. It turns out we forgot to pick-up Finn when we left. Now he's being held ransom by Junk Boss Plutt. We'll need to act fast to get to him before the Empire does. __Blast off!__ 

<br>

![](../images/finn_run.gif){style="margin-left: 18%; width: 60%; margin-top: 6px;"}

<br>


# More Jakku trash
<hr>
```{r convert-tbl, child='X:/Agency_Files/Outcomes/Risk_Eval_Air_Mod/_Air_Risk_Evaluation/R/R_Camp/modules/ton_conversion_tbl.Rmd'}
```


# Join tables with `left_join()`
<hr>
```{r intro-join, child='X:/Agency_Files/Outcomes/Risk_Eval_Air_Mod/_Air_Risk_Evaluation/R/R_Camp/modules/dplyr_leftjoin/intro_scrap.Rmd'}
```

```{r porg-join, child='X:/Agency_Files/Outcomes/Risk_Eval_Air_Mod/_Air_Risk_Evaluation/R/R_Camp/modules/dplyr_leftjoin/porg_names.Rmd'}
```

```{r c3po-join, child='X:/Agency_Files/Outcomes/Risk_Eval_Air_Mod/_Air_Risk_Evaluation/R/R_Camp/modules/dplyr_leftjoin/c3po_xtra_rows.Rmd'}
```


## Back to the scrap yard {-}
<hr class="hrlvl2">
```{r join-convert, child='X:/Agency_Files/Outcomes/Risk_Eval_Air_Mod/_Air_Risk_Evaluation/R/R_Camp/modules/dplyr_leftjoin/convert_&_scrap.Rmd'}
```

```{r calc-lbs-item, child='X:/Agency_Files/Outcomes/Risk_Eval_Air_Mod/_Air_Risk_Evaluation/R/R_Camp/modules/dplyr_mutate/pounds_per_scrap.Rmd'}
```


<div class="note" style="line-height: 1.6;">
### Note {-}

Analysts often get asked questions:

- What's the highest number? 
- What's the lowest number? 
- What was the average tons of scrap from Cratertown last year? 
- Which town's scrap was worth the most credits?

</div>


# `summarize()` this
<hr>

![](../images/summarize_diagram.png){width="490"}

`summarize()` allows you to apply a summary function like `median()` to a column and collapse the data down to a single row. To dig into `summarize` you'll want to learn some more summary functions like `sum()`, `mean()`, `min()`, and `max()`.


## `sum()` {-}

Use `summarize()` and `sum()` to find the total credits from all the scrap.

```{r, eval = F}
summarize(scrap, total_credits = sum(credits))
```


## `mean()` {-}
Use `summarize()` and `mean()` to calculate the _mean_ `price_per_pound` in the scrap report.

```{r, eval = F}

summarize(scrap, mean_price = mean(price_per_pound, na.rm = T))

```

<br>

> Note the `na.rm = TRUE` in the `mean()` function. This tells R to ignore empty cells or missing values that show up in R as `NA`. If you leave `na.rm` out, the _mean_ function will return 'NA' if it finds a missing value in the data.


## `median()` {-}
Use summarize to calculate the _median_ price_per_pound in the scrap report.

`summarize(scrap, median_price = median(price_per_pound, na.rm = T))`

## `max()` {-}
Use summarize to calculate the _maximum_ price per pound any scrapper got for their scrap.

`summarize(scrap, max_price = max(price_per_pound, na.rm = T))`

## `min()` {-}
Use summarize to calculate the _minimum_ price per pound any scrapper got for their scrap.

`summarize(scrap, min_price = min(price_per_pound, na.rm = T))`

## `nth()` {-}
Use `summarize()` and `nth(Origin, 12)` to find the name of the Origin City that got the  _12th_ highest scrapper haul.   

_Hint: Use `arrange()` first._

`arrange(scrap, desc(credits)) %>% summarize(price_12 = nth(origin, 12))`

## `sd()` {-}

What is the _standard deviation_ of the credits?

`summarize(scrap, stdev_credits = sd(credits))`

## `quantile()` {-}

_Quantiles_ are useful for finding the upper or lower range of a column. Use the `quantile()` function to find the the 5th and 95th quantile of the prices.

```{r quants, eval = FALSE}
summarize(scrap, 
          price_5th_pctile  = quantile(price_per_pound, 0.05, na.rm = T),
          price_95th_pctile = quantile(price_per_pound, 0.95))
```


__Hint:__ Add `na.rm = T` to `quantile()`.


## `n()` {-}

`n()` stands for _count_.

Use summarize and `n()` to count the number of reported scrap records going to `Niima outpost`. 

__Hint:__ Use `filter()` first.

```{r, eval=F}
niima_scrap <- filter(scrap, destination == "Niima Outpost") 

niima_scrap <- summarize(niima_scrap, scrap_records = n())

```

<br>


<div class="tip">
### <i class="fa fa-user-astronaut" style="color: green;"></i> Explore! {-}

Create a summary of the scrap data that includes 3 of the summary functions above. The following is one example.

```{r, eval = F}
summary <- summarize(scrap, 
                     max_credits      = __________,
                     weight_90th_pct  = quantile(Weight, 0.90),
                     count_records    = __________,
                    
```

<br>



> ### __Shut me down!__ {-}
>
> That was a whole lot of summarizing. Do we really have to filter to the Origin City that we're interested in every time? 
>
> It sure would be nice if we could easily find the mean price for every Origin City. Then we could summarize once and be done with it.
>

#### It's time for `group_by()`! {-}

</div>

# `group_by()` what
<hr>

## Bargain hunters {-}

Who's selling goods for cheap? Use `group_by` with the column _Origin_, and then use`summarize` to find the `mean(price_per_pound)` at each Origin City. 

```{r mean_price-by-origin, eval = F}
scrap_summary <- group_by(scrap, origin) %>% 
                 summarize(mean_price =  mean(price_per_pound, na.rm = T)) 
```

<br>

<details>
<summary class="btn_code_blue"> Rounding digits </summary>

<div class="note">
<p>
You can round the prices to a certain number of digits using the `round()` function. We can finish by adding the `arrange()` function to sort the table by our new column.

```{r mean_price-by-Origin-round, eval = F}
scrap_means <- group_by(scrap, origin) %>% 
                 summarize(mean_price       =  mean(price_per_pound, na.rm = T),
                           mean_price_round = round(mean_price, digits = 2)) %>%  
                 arrange(mean_price_round) %>%
                 ungroup()
```

<br>


__NOTE:__ 

The `round()` function in R does not automatically round values ending in 5 up. Instead it uses scientific rounding, which rounds values ending in 5 to the nearest even number. So 2.5 rounded to the nearest whole number rounds down to 2, and 3.5 rounded to the nearest whole number rounds up 4.

</p>
</div>
</details>


<br>

Who's making lots of transactions? Try using `group_by` with the column _origin_ and then `summarize` to count the number of scrap records at each city.  

```{r grp-by-origin, eval = FALSE}
scrap_counts <- group_by(scrap, origin) %>% 
                summarize(origin_count  =  n()) %>% 
                ungroup()

```

<br>

### <i class="fa fa-user-astronaut" aria-hidden="true" style="color:#040707;"></i> Pro-tip! {-}
<div class="well">

Ending with `ungroup()` is good practice. This prevents your data from staying grouped after the summarizing has been completed.

</div>


# Save files
<hr>

Let's save the mean price summary table we created to a _CSV_. That way we can transfer it to a _droid courier_ for delivery to Rey. To save a data frame we can use the `write_csv()` function from our favorite `readr` package. 

```{r, eval=F}
# Write the file to your results folder
write_csv(scrap_means, "results/prices_by_origin.csv")
```

<br>


<div class="well">
### <i class="fa fa-user-astronaut" aria-hidden="true" style="color:#040707;"></i> __Warning!__ {-}

By default, when saving R will overwrite a file if the file already exists in the same folder. It will not ask for confirmation. To be safe, save processed data to a new folder called `results/` and not to your raw `data/` folder.

</div>


# Grouped `mutate()` 
<hr>

We can bring back `mutate` to add a column based on the grouped values in a data set. For example, you may want to add a column showing the mean price by origin to the whole table, but still keep all of the records. This is a good way to add values to the table to serve as a reference point. 

> How does the price of Item X compare to the average price?  

When you combine `group_by` and `mutate` the new column will be calculated based on the values within each group. Let's group by `origin` to find the `mean()` price per pound at each origin. 


```{r mutate-price, eval=F}
scrap <- group_by(scrap, origin) %>% 
            mutate(origin_mean_price = mean(price_per_pound, na.rm = T)) %>% 
            ungroup()
```

<br>

```{r, include=F}
# Save scrap data for Day 2 PM
write_csv(scrap, "scrap_day2_pm.csv")
```


### <i class="fa fa-rocket" aria-hidden="true"></i> Return to [Homebase](../post/day-2.html) {-}

<br>

